<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piper TTS Streaming</title>
</head>
<body>
    <h2>Piper TTS Streaming</h2>
    <textarea id="textInput" rows="4" cols="50">Hello, how are you?</textarea><br>
    <button onclick="sendText()">Speak</button>

    <script>
        // Get scriptFile from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const scriptFile = urlParams.get('scriptFile');
        
        if (!scriptFile) {
            alert('scriptFile parameter is required in the URL');
            throw new Error('scriptFile parameter is required');
        }

        // Create WebSocket URL with scriptFile parameter
        const wsUrl = `ws://localhost:3000?scriptFile=${encodeURIComponent(scriptFile)}`;
        const ws = new WebSocket(wsUrl);
        ws.binaryType = "arraybuffer"; // Ensure binary WebSocket handling

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 22050 });
        let audioQueue = [];
        let isPlaying = false;

        ws.onopen = () => {
            console.log("Connected to TTS server");
        };

        ws.onmessage = async (event) => {
            console.log("text received");
            const rawPCM = new Int16Array(event.data); // Read as 16-bit PCM
            audioQueue.push(rawPCM);
            if (!isPlaying) {
                playNextChunk();
            }
        };

        ws.onclose = () => {
            console.log("Disconnected from TTS stream");
        };

        function sendText() {
            // const text = document.getElementById("textInput").value;
            // ws.send(text);
            ws.send("next");
        }

        function playNextChunk() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                console.log("audioQueue.length equals zero");
                ws.send("next");
                return;
            }
            isPlaying = true;

            const rawPCM = audioQueue.shift();
            const buffer = audioCtx.createBuffer(1, rawPCM.length, 22050);
            const channelData = buffer.getChannelData(0);

            // Convert Int16 PCM to normalized float (-1 to 1 range)
            for (let i = 0; i < rawPCM.length; i++) {
                channelData[i] = rawPCM[i] / 32768.0;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start();

            source.onended = playNextChunk;
        }
    </script>
</body>
</html>
